---
title: "ProyectoAED2023"
author: "Carlos, Diego, Miguel"
date: "2023-11-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

En el presente informe planteamos el análisis exploratorio de un conjunto de datos sobre la calidad del aire de la ciudad de Valencia entre 2004 y 2022. El dataset empleado continene observaciones obtenidas de distintas estaciones de la red de vigilancia de Valencia. Las observaciones están compuestas por variables respectivas a diversas moleculas y elementos presentes en el aire junto a otras de tipo meteorológico como la velocidad del viento, la temperatura, etc.

El procedimiento a seguir comenzará con la correcta importación del dataset, a lo que seguirá la preparación de los datos para resolver las preguntas planteadas. Se escogerán las variables de interés y los periodos temporales sobre los que se realizará el análisis, se aplicarán las transformaciones necesarias sobre las variables, se reestructurará el dataset acorde a nuestras necesidades y se gestionarán los outliers y datos faltantes.

Una vez preparado el dataset, procederemos a responder a las preguntas planteadas mediante diversas metodologías. Todo el proceso irá acompañado de las explicaciones pertinentes y finalizaremos con una conclusión del trabajo realizado.



# Objetivos

El objetivo principal de este trabajo es familizarse con las herramientas y metodologías aprendidas para la carga, manipulación y análisis exploratorio de un conjunto de datos. Para ello se van a plantear una serie de objetivos es forma de preguntas que requerirán la aplicación de las herramientas y metodologías aprendidas:

+ ¿?Influencia del cambio en el tráfico hacia el centro de la ciudad en los últimos años. (carriles bici) : Comprobar posible reducción de gases emitidos por vehículos a motor en las estaciones más céntricas.

+ ¿?Relación radiación solar con ozono

+ ¿?Existe cierta evolución de la contaminación sonora (años/zonas)

+ ¿?Existe cierta evolución de la temperatura

+ ¿?Existe cierta evolución de la contaminación. Como medir la contaminación

+ ¿?Existe alguna diferencia entre las distintas estaciones

+ ¿?Existe alguna correlación entre la calidad del aire y el día de la semana/año

+ ...

A lo largo del desarrollo del proyecto se irán planteando y resolviendo las preguntas anteriores junto a su razonamiento y conclusiones.



# Carga de librerías y datos

[Explicar la estructura del dataset sin modificar]

[Escoger variables para "calidad del aire"]



```{r}
library(readr) # Carga de datos
library(lubridate) # Manejo de datos
library(tidyr) # Manejo de datos
library(dplyr) # Manejo de datos
library(ggplot2) # Visualización de datos
library(plotly) # Visualización de datos interactiva
```
# Importación de los datos y análisis de las variables

El primer paso es importar nuestro dataset. Para ello, en primer lugar abrimos (por ejemplo en un bloc de notas) el archivo _rvvcca.csv_ localizado en la carpeta data. De esta forma vemos el formato en el que están guardados los datos, lo cuál es importante para su correcta importación. Por ejemplo, vemos que el separador de las variables es ';', lo cuál debe ser especificado en la función _read.csv()_ ya que esta toma por defecto espera ',' como separador.

```{r}
# Especificamos el tipo de columna para que los datos se importen directamente con un formato adecuado
column_types <- cols(
  Fecha = col_date(format = "%Y-%m-%d"),
  `Dia de la semana` = col_factor(levels = c("Lunes", "Martes",  "Miercoles", "Jueves", "Viernes", "Sabado", "Domingo")),
  `Dia del mes` = col_factor(levels = as.character(1:31)),
  Estacion = col_factor(),
  `Fecha creacion`= col_date(format = "%Y-%m-%d"),
  `Fecha baja`= col_date(format = "%Y-%m-%d"))

# importación del dataset
datos <- read_delim("data/rvvcca.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE, col_types = column_types)

# renombramos las varianles con espacios en su nombre para trabajar sin comillas ' ' y eliminamos el sufijo (ng/m³) de algunas variables
colnames(datos) <- gsub(x = colnames(datos), pattern=' ', replacement = '_')
colnames(datos) <- gsub(x = colnames(datos), pattern='_[(]ng[/]m³[)]$', replacement = '')

head(datos)
```

# Separar dataframe principal en una lista de dataframes por estaciones
```{r}
estaciones <- unique(datos$Estacion)
datos_separados <- list()

for(s in estaciones){
  datos_estacion <- datos[datos$Estacion == s,]
  datos_separados <- append(datos_separados,list(datos_estacion))
}

names(datos_separados) <- estaciones
```




La página de donde se obtuvo el dataset no presentaba ninguna explicación de las variables, pero podemos extraer las siguientes conclusiones:

- *Id* es un identificador para cada una de las filas y no aporta ninguna información concreta.

- *Fecha* es una variable tipo *Date* que nos proporciona la fecha en que se tomaron las medidas del resto de variables numéricas. Tomaremos esta variable para la ordenación ascendente de los datos.

- *Dia_de_la_semana* y *Dia_del_mes* son variables de tipo factor que indican en que día de la semana y en qué dia del mes se realiza la medida. Puede ser extraído a partir de *Fecha* usando las funciones _wday()_ y _day()_, de la librería _lubridate_.

- *Estacion* es una variable de tipo factor cuyos niveles son las distintas estaciones meteorológicas donde se tomaron las mediciones de las variables numéricas.

- *PM1, PM2.5, PM10* son variables de tipo numérico con datos sobre la concentración de materiales particuldos (OM) de menos de 1, 2.5 y 10 micrómetros de diámetro respectivamente.

- *NO, NO2, NOx, O2, SO2, CO, NH3* son variables con datos sobre la concentración de estas moléculas inorgánicas consideradas contaminantes en el aire.

- *C7H8, C6H6, C8H10* son variables con datos sobre la concentración de estas moléculas orgánicas también consideradas contaminantes en el aire.

- *Velocidad_del_viento, Direccion_del_viento, Temperatura, Humidad_relativa, Presion, Radiacion_solar, Precipitacion, Velocidad_maxima_del_viento* son variables numéricas con mediciones de estas distintas condiciones ambientales al momento de medir las concentraciones de moléculas contaminantes en el aire. Es interesante contar con estos datos para ver si influyen en los valores de contaminación.

- *As, Ni, Cd, Pb, B(a)p* son variables numéricas con datos de otras concentraciones de gases y metales contaminantes en el aire. Todos estas variables presentaban el prefijo (ng/m3) indicando las unidades en que se mide sus concentraciones. El resto de datos de concentraciones no presentan las unidades lo cuál nos hace sospechar que auiás los datos de estas variables fueron unidos a este dataset a posteriori.

- *Fecha_creación* y *Fecha_baja* son variables de tipo *Date* que parecen estar relacionadas con la creacion del dataset y que no parecen aportar información sobre nuestros datos.

```{r}
unique(datos$Fecha_creacion)
unique(datos$Fecha_baja)
```
 *Fecha_creación* solo presenta dos entradas distintas y *Fecha_baja* sólo presenta NA's por lo que estas variables parecen prescindibles`
 
Vamos a mantener sólo las variables que aporten alguna información relevante:
```{r}
datos <- datos %>% select(-c('Id', 'Dia_de_la_semana','Dia_del_mes','Fecha_creacion', 'Fecha_baja'))
```


# Análisis de datos faltantes y especiales

En primer lugar vamos reemplazar todos los posibles valores especiales (NULL, NaN, Inf...)  que pudieran haber en las varianles numéricas de nuestro dataset por NA's. De esta forma podemos tratar todos estos datos que no tienen sentido a la vez.

```{r}
variables_numericas <- colnames(datos[sapply(datos,is.numeric)])
reemplazo_especiales <- function(x){
  return(ifelse(is.finite(x), x, NA))
}
datos <- mutate(datos, across(all_of(variables_numericas), reemplazo_especiales))
```

A continuación vamos a calcular el porcentaje de NA's que tiene cada variable;

```{r}
porc_na <- function(x){
  100*sum(is.na(x))/length(x)
}
datos %>% summarise(across(.cols = all_of(colnames(datos)), .fns = porc_na)) %>% pivot_longer(cols = all_of(colnames(datos)), names_to = 'Variable', values_to = "Porcentaje NA's") %>% arrange(desc(`Porcentaje NA's`)) %>% mutate(`Porcentaje NA's`=round(`Porcentaje NA's`, digits = 2))
```

Vemos como la variable B(a)p está casi vacía (sólo tiene una entrada) y hay varias variables con un porcentaje de NA's por encima del 90% y muchas otras por encima del 50%. Esto quizá sea debido a que algunas variables se empezaron a medir más tarde que otras o a que no en todas las estaciones se miden todas las variables.

```{r}
num_entradas <- function(x){
  sum(!is.na(x))
}
est_var <- datos %>% group_by(Estacion) %>% summarise(across(.cols = all_of(variables_numericas), .fns = num_entradas)) %>% pivot_longer(cols = all_of(variables_numericas), names_to = 'Variable', values_to = "Numero_entradas") %>% mutate(Variable = factor(Variable, levels = variables_numericas, ordered = T)) %>% arrange(match(Variable, variables_numericas))
p <- ggplot(data = est_var, aes(x = Estacion, y=Variable, fill = Numero_entradas)) + geom_tile() + scale_fill_gradient(low = "white", high = "blue") + theme(axis.text.x=element_text(angle=45, hjust=1))
plotly::ggplotly(p)
```

En este mapa de calor podemos ver qué varaibles mide cada estación meteorológica, además de la cantidad de datos que aporta cada una de ellas sobre cada varaible numéricaa. Vemos como sólo hay dos estaciones (Viveros y Boulevard Sud) que miden las variables *As*, *Pb*, *Ni* y *Cd* y que su número de entradas es bajo en comparación con otras variable, quizá debido a que se empezaron a tomar datos de estas variables más tarde que el resto. En el caso del *NH3* vemos que solo se ha medido en la estación Boulevard Sud. Las moléculas orgánicas *C8H10*, *C6H6*, *C7H8* sólo se miden en las estaciones de Pista de Silla y Viveros. Cabe destacar también que las estaciones que miden mayor cantidad de variables son Pista de Silla, Viveros y Boulevard Sud. Por otro lado, estaciones como Conselleria Meteo y Nazaret Meteo sólo miden las condiciones ambientales y no las concentraciones de contaminantes,al igual que la estación del Puerto de Valencia con la diferencia que en esta además se miden los niveles de partículas *PM10* y de *SO2*. Además, vemos como en la estación de Valencia Olivereta sólo se miden niveles de partículas *PM2.5*, *PM10* y óxidos de nitrógeno.

Ahora queremos ver qué estaciones han estado activas a lo largo de los años:

```{r}
datos %>% mutate(ano = factor(year(Fecha))) %>% ggplot(aes(x=ano, fill = Estacion)) + geom_bar() + labs(x = 'Año') + theme(axis.text.x=element_text(angle=45, hjust=1))
```

Como podemos ver, desde 2004 hasta 2007 sólo tenemos datos de las estaciones de Pista de Silla y Viveros, que se mantienen actvas hasta 2022. Posteriormente, en los siguientes 5 años (2008-2012) se van añadiendo datos de otras estaciones como la del Politécnico, Av. de Francia, Molí del Sol, Boulevard Sur, Valencia Centro y Conselleria a razón casi de una nueva estación al año y que se mantienen hasta el final (2022). Desde 2013 hasta 2016 se siguen viendo las mismas estaciones y en los siguientes dos años (2017-2018) se añaden datos de la estación del Puerto de Valencia, de la que posteriormente dejamos de obtener datos. Finalmente, desde 2019 hasta 2022 se van añadiendo progresivamente cada año las estaciones de Nazaret, Puerto Molí Trans. Ponent, Puerto antic Turia y Valencia Olivereta. 2022 es el año donde tenemos datos de más estaciones distintas.

A continuación queremos visualizar el período de tiempo entre la primera y la última medida de cada variable

```{r}
# Alternativa: creamos una lista de dataframes, uno para cada variable, conteniendo las observaciones que no son NA
# La primera observación es el inicio de la toma de muestras y la última el fin, ya que se ha ordenado por fecha previamente
series_temporales <- list()
variables <- colnames(datos)[4:length(colnames(datos))]

for (i in 1:length(variables) ) {
  df <- data.frame(fecha = datos$Fecha, valor = datos[[variables[i]]]) %>% na.omit
  series_temporales[[i]] <- df
}
names(series_temporales) <- variables

ggplot() + geom_line(data = series_temporales[[1]], aes(fecha,valor)) + ylab(variables[1])
```

```{r}
# Construimos el cata.frame 'segmentos' que contiene la primera y la última fecha con datos de cada una de nuestras variables numéricas
segmentos <- data.frame(variable = colnames(datos)[6:length(colnames(datos))])
fecha_inicio <- as.Date(rep(0,nrow(segmentos)))
fecha_fin <- as.Date(rep(0,nrow(segmentos)))
porc_na <- rep(0,nrow(segmentos))
for (i in 1:nrow(segmentos)) {
  # fecha de la primera entrada con datos de la variable i
  fecha_inicio[i] <- datos$Fecha[!is.na(datos[,segmentos[i,1]])][1]
  # fecha de la última entrada con datos de la variable i
  fecha_fin[i] <- datos$Fecha[!is.na(datos[,segmentos[i,1]])][length(datos$Fecha[!is.na(datos[,segmentos[i,1]])])]
  filtro <- filter(datos, Fecha >= fecha_inicio[i], Fecha <= fecha_fin[i])
  # porcentaje de datos faltantes en la variable i desde la primera entrada con datos hasta la última
  porc_na[i] <- sum(is.na(filtro[,segmentos[i,1]]))*100/nrow(filtro)
}
segmentos$fecha_inicio <- fecha_inicio
segmentos$fecha_fin <- fecha_fin
segmentos$porc_na <- porc_na

# Representamos los segmentos de tiempo entre los que hay datos para cada una de las variables
ggplot(data = segmentos, aes(y = variable, color = porc_na)) + geom_segment(aes(x = fecha_inicio, xend = fecha_fin, yend = variable), lwd = 1.2) + geom_point(aes(x = fecha_inicio)) + geom_point(aes(x = fecha_fin)) + labs(title = 'Período de tiempo entre la primera y la última medida', x = 'Fecha') + scale_color_gradient("Porcentaje NA's", low = 'blue',high = 'red')
```

A partir de este gráfico podemos ver como algunas variables empiezan a ser medidas a partir de cierta fecha. En concreto, los datos de *As*, *Cd*, *NH3*, *Ni*, *Pb* y *Prceipitacióo* empiezan a tomarse sólo a partir de 2019. En el caso del *B(a)* solo tenemos una entrada por lo que debemos dejar de considerar esta variable. Otras variables como *Velocidad_maxima_del_viento*  o *PM1* empiezan a tener datos un poco más tarde que el resto pero antes del 2019. Todas las demás variables presentan almenos algún dato en 2004. Por otro lado, los datos de *As*, *Ni*, *Cd* y *Ob* terminan antes que el resto de variables, a principios del 2022. Además, en el dódigo de colores se muestra el porcentaje de datos faltantes de cada variable en el período que ba desde la fecha de la primera toma de datos de esta variable hasta la fecha de la última. Cabe destacar en este aspecto que las variables *As*, *Cd*, *NH3*, *Ni*, *Pb*, tienen un porcentaje muy elevado de NA's (alrededor del 90%) al igual que las variabñes *C8H10*, *C7H8* y *C6H6*, pero en un período de tiempo mucho más pequeño.

También queremos ver qué estaciones meteorológicas han estado recogiendo datos a lo largo de los años


# Influencia de carril bici

Para estudiar la influencia de un carril bici por el centro de Valencia, estudiaremos la evolución de gases contaminantes en diversas estaciones de la ciudad. Mediremos la evolución de los gases:

+ SO2: Originado sobre todo durante la combustión de carburantes fósiles.
+ NO2: Es un contaminante atmosférico cuyas fuentes fundamentales son el tráfico rodado, así como las emisiones de determinadas industrias y grandes instalaciones de combustión.

Además, las estaciones deberían ser las más céntricas, ya que ahí el efecto del carril bici y las restricciones de acceso deberían hacerse más notables. Observaremos las siguientes estaciones:

+ Avda. Francia
+ Bulevard Sud
+ Valencia Centro
+ Olivereta

```{r}
datos_mensuales <- datos[c("Fecha","SO2","NO2","Estacion")] %>%
  filter(Estacion %in% c("Avda. Francia","Bulevard Sud", "Valencia Centro", "Olivereta")) %>%
  mutate(ano = year(Fecha), mes = month(Fecha)) %>%
  arrange(Fecha) %>%
  group_by(ano, mes) %>%
  summarise(media_SO2 = mean(SO2, na.rm=TRUE), media_NO2 = mean(NO2,na.rm=TRUE), .groups="drop")

ggplot(data = datos_mensuales, aes(x = mes, y = media_SO2, group = ano, color = factor(ano))) +
  geom_line() +
  labs(x = "Mes", y = "Media SO2", title = "Media Mensual SO2 por Año") +
  scale_color_discrete(name = "Año") +
  scale_x_continuous(breaks = 1:12, labels = month.abb, limits = c(1, 12)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data = datos_mensuales, aes(x = mes, y = media_NO2, group = ano, color = factor(ano))) +
  geom_line() +
  labs(x = "Mes", y = "Media NO2", title = "Media Mensual NO2 por Año") +
  scale_color_discrete(name = "Año") +
  scale_x_continuous(breaks = 1:12, labels = month.abb, limits = c(1, 12)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Si bien no se observan cambios significativos en los niveles de SO2, en los niveles de NO2 sí que podemos observar una evolución.

